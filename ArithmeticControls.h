#ifndef I960_ARITHMETIC_CONTROLS_H__
#define I960_ARITHMETIC_CONTROLS_H__

#include "types.h"
namespace i960 {
    /**
     * Arithmetic controls register, will eventually encompass all modes, core architecture only now.
     */
    class ArithmeticControls {
        public:
            constexpr ArithmeticControls(Ordinal rawValue) noexcept : 
                _conditionCode(extractConditionCode(rawValue)),
                _integerOverflowFlag(extractIntegerOverflowFlag(rawValue)),
                _integerOverflowMask(extractIntegerOverflowMask(rawValue)),
                _noImpreciseFaults(extractNoImpreciseFaults(rawValue)) { }
            constexpr ArithmeticControls() noexcept = default;
            ~ArithmeticControls() = default;
            constexpr auto getConditionCode() const noexcept { return _conditionCode; }
            template<Ordinal mask = 0b111>
            constexpr auto getConditionCode() const noexcept { 
                if constexpr (mask >= 0b111) {
                    return _conditionCode;
                } else if constexpr (mask == 0) {
                    return 0;
                } else {
                    return _conditionCode & mask;
                }
            }

            constexpr auto getConditionCode(Ordinal mask) const noexcept {
                return _conditionCode & mask;
            }

            constexpr auto integerOverflowFlagSet() const noexcept { return _integerOverflowFlag; }
            constexpr auto maskIntegerOverflow() const noexcept { return _integerOverflowMask; }
            constexpr auto noImpreciseFaults() const noexcept { return _noImpreciseFaults; }
            void setConditionCode(Ordinal value) noexcept { _conditionCode = value; }
            void setIntegerOverflowFlag(bool value) noexcept { _integerOverflowFlag = value; }
            void setIntegerOverflowMask(bool value) noexcept { _integerOverflowMask = value; }
            void setNoImpreciseFaults(bool value) noexcept { _noImpreciseFaults = value; }
            void clearConditionCode() noexcept { _conditionCode = 0; }
            template<Ordinal mask>
            constexpr auto conditionCodeIs() const noexcept { return _conditionCode == mask; }
            constexpr auto conditionCodeIs(Ordinal mask) const noexcept { return _conditionCode == mask; }
            template<Ordinal mask>
            constexpr bool conditionCodeBitSet() const noexcept { return getConditionCode<mask>() != 0; }
            constexpr bool conditionCodeBitSet(Ordinal mask) const noexcept { return getConditionCode(mask) != 0; }
            constexpr bool shouldCarryOut() const noexcept {
                // 0b01X where X is don't care
                return _conditionCode == 0b010 || _conditionCode == 0b011;
            }
            constexpr bool markedAsOverflow() const noexcept {
                // 0b0X1 where X is don't care
                return _conditionCode == 0b001 || _conditionCode == 0b011;
            }
            constexpr bool carrySet() const noexcept { return conditionCodeBitSet<0b010>(); }
            constexpr Ordinal getCarryValue() const noexcept { return carrySet() ? 1 : 0; }
        private:
            Ordinal _conditionCode = 0;
            /**
             * Denotes an integer overflow happened
             */
            bool _integerOverflowFlag = false;
            /**
             * Inhibit the processor from invoking a fault handler
             * when integer overflow is detected.
             */
            bool _integerOverflowMask = false;
            /**
             * Disable faults generated by imprecise results being generated
             */
            bool _noImpreciseFaults = false;
#if 0
                struct {
                    // Core architecture AC
                    Ordinal _conditionCode : 3;
                    Ordinal reserved0 : 5;
                    Ordinal _integerOverflowFlag : 1;
                    Ordinal reserved1 : 3;
                    Ordinal _integerOverflowMask : 1;
                    /**
                     * Reserved, always bind to zero
                     */
                    Ordinal reserved2 : 2;
                    Ordinal _noImpreciseFaults : 1;
                    Ordinal reserved3 : 16;
                };
#endif
        public:
            static constexpr Ordinal extractConditionCode(Ordinal raw) noexcept {
                return raw & 0b111;
            }
            static constexpr bool extractIntegerOverflowFlag(Ordinal raw) noexcept {
                return (raw >> 8) & 1;
            }
            static constexpr bool extractIntegerOverflowMask(Ordinal raw) noexcept {
                return (raw >> 12) & 1;
            }
            static constexpr bool extractNoImpreciseFaults(Ordinal raw) noexcept {
                return (raw >> 15) & 1;
            }
    };

} // end namespace i960
#endif // end I960_ARITHMETIC_CONTROLS_H__
